# README - 稳健版应用启动器

## 概述

这是一个完全重写的、稳定可靠的应用启动器，解决了原版本中存在的各种bug和性能问题。新版本采用了更好的架构设计，提供了详细的错误处理和调试信息。

## 主要改进

### 1. 架构重构
- **模块化设计**：将扫描器和启动器分离为独立模块
- **异步处理**：全面采用异步编程，避免阻塞
- **数据类**：使用Python dataclass简化数据结构
- **类型提示**：完整的类型注解，提高代码可维护性

### 2. 性能优化
- **增量扫描**：支持增量扫描，避免重复工作
- **智能缓存**：多级缓存机制，提高响应速度
- **并发处理**：并行扫描多个来源
- **资源限制**：防止内存和CPU过度使用

### 3. 错误处理
- **详细日志**：完整的日志记录和错误追踪
- **重试机制**：智能重试失败的操作
- **优雅降级**：某个部分失败不影响整体功能
- **错误分类**：不同类型的错误有专门的处理逻辑

### 4. 安全性增强
- **路径验证**：验证可执行文件的有效性
- **权限检查**：检查文件访问权限
- **进程监控**：监控启动的进程状态
- **安全启动**：支持以管理员权限启动

### 5. 调试支持
- **调试模式**：详细的调试信息和日志
- **统计信息**：完整的性能和使用统计
- **测试套件**：完整的单元测试覆盖

## 文件结构

```
mcpserver/agent_open_launcher/
├── robust_app_launcher_agent.py    # 主Agent类
├── enhanced_app_scanner.py        # 增强版应用扫描器
├── enhanced_app_launcher.py       # 增强版应用启动器
├── test_enhanced_app_scanner.py   # 扫描器测试
├── test_enhanced_app_launcher.py  # 启动器测试
├── test_robust_app_launcher_agent.py # Agent测试
├── run_tests.py                   # 测试运行脚本
├── robust_config.env              # 配置文件
├── agent-manifest.json           # Agent元数据
└── README.md                     # 说明文档
```

## 使用方法

### 1. 运行测试

```bash
# 运行所有测试
python run_tests.py

# 运行特定测试模块
python run_tests.py test_enhanced_app_scanner
```

### 2. 配置说明

编辑 `robust_config.env` 文件来自定义行为：

```env
# 启用调试模式
DEBUG_MODE=true

# 设置缓存时间
CACHE_TTL=7200

# 限制扫描的应用数量
MAX_APPS_SCAN=500
```

### 3. 在NagaAgent中使用

1. 将新的Agent类注册到系统
2. 更新 `agent-manifest.json` 中的入口点
3. 重启NagaAgent服务

## API接口

### 支持的工具

1. **启动应用**
   - 两轮交互：第一轮获取列表，第二轮启动
   - 支持启动参数和选项
   - 返回详细的启动状态

2. **获取应用列表**
   - 返回系统中所有可用应用
   - 支持分页和过滤
   - 包含应用来源信息

3. **终止应用**
   - 安全终止运行中的应用
   - 支持强制结束

4. **获取运行中的应用**
   - 列出当前运行的应用
   - 包含进程信息

5. **刷新应用列表**
   - 重新扫描系统
   - 更新缓存

6. **获取启动历史**
   - 查看历史启动记录
   - 包含成功/失败状态

7. **获取统计信息**
   - 系统使用统计
   - 性能指标

## 错误代码

| 代码 | 说明 | 处理建议 |
|------|------|----------|
| SUCCESS | 成功 | - |
| NOT_FOUND | 应用未找到 | 检查应用名称 |
| ALREADY_RUNNING | 已在运行 | 终止后重试 |
| ACCESS_DENIED | 权限不足 | 以管理员身份运行 |
| INVALID_PATH | 无效路径 | 重新安装应用 |
| TIMEOUT | 超时 | 增加超时时间 |
| FAILED | 启动失败 | 查看日志详情 |

## 故障排除

### 1. 应用无法启动

- 检查应用路径是否存在
- 确认有足够的权限
- 查看调试日志获取详细信息

### 2. 扫描速度慢

- 减少MAX_APPS_SCAN的值
- 启用缓存功能
- 排除不需要的扫描位置

### 3. 内存使用过高

- 限制缓存大小
- 定期刷新应用列表
- 监控进程状态

## 开发指南

### 添加新的应用来源

1. 在 `AppSource` 枚举中添加新类型
2. 在 `EnhancedAppScanner` 中实现扫描方法
3. 更新优先级逻辑
4. 添加相应的测试

### 添加新的启动方式

1. 在 `EnhancedAppLauncher` 中添加新方法
2. 实现错误处理和重试逻辑
3. 添加启动历史记录
4. 编写测试用例

## 性能优化建议

1. **合理设置缓存时间**：根据应用更新频率调整
2. **限制扫描范围**：只扫描必要的目录
3. **使用增量扫描**：避免全量扫描
4. **监控资源使用**：定期检查内存和CPU使用

## 安全注意事项

1. **验证可执行文件**：确保只启动可信的应用
2. **检查权限**：避免权限提升攻击
3. **监控进程**：及时发现异常行为
4. **日志审计**：记录所有启动操作

## 更新日志

### v3.0.0 (当前版本)
- 完全重写架构
- 添加完整的测试套件
- 改进错误处理
- 优化性能
- 增强安全性

### v2.2.0 (原版本)
- 基础功能实现
- 简单的错误处理
- 基本的应用扫描

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 许可证

MIT License